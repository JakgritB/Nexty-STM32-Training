#include <stdint.h>
#define STM32F411xE
#include "stm32f4xx.h"

void EXTI_IRQHandler(void) {
	if ((EXTI->PR & EXTI_PR_PR4) != 0) {
		if ((GPIOB->IDR & GPIO_IDR_ID4) == 0) {
			GPIOA->ODR |= (GPIO_ODR_OD5);
		} else {
			GPIOA->ODR &= ~(GPIO_ODR_OD5);
		}
	}
	GPIOA->ODR ^= (GPIO_ODR_OD5);
}

int main(void) {
	RCC->AHB1ENR |= (RCC_AHB1ENR_GPIOAEN + RCC_AHB1ENR_GPIOBEN);
	RCC->APB2ENR |= RCC_APB2ENR_SYSCFGEN;

	// PA5 (LED)
	GPIOA->MODER &= ~GPIO_MODER_MODER5;
	GPIOA->MODER |= (0b01 << GPIO_MODER_MODER5_Pos);
	GPIOA->OTYPER &= ~(GPIO_OTYPER_OT5);
	GPIOA->OSPEEDR &= ~(GPIO_OSPEEDR_OSPEED5);

	//PA4
	GPIOB->MODER &= ~(GPIO_MODER_MODER4);
	GPIOB->PUPDR &= ~(GPIO_PUPDR_PUPD4);
	GPIOB->PUPDR |= (0b01 << GPIO_PUPDR_PUPD4_Pos);

	// PA3 (RX only)
	GPIOA->MODER |= (0b10 << GPIO_MODER_MODER3_Pos);
	GPIOA->AFR[0] |= (0b0111 << GPIO_AFRL_AFSEL3_Pos);

	// USART (RX only)
	USART2->CR1 |= USART_CR1_UE;
	USART2->BRR = 139;
	USART2->CR1 |= USART_CR1_RE;

	while (1) {
		if (USART2->DR == '1') {
			GPIOA->ODR |= (GPIO_ODR_OD5);

		} else {
			GPIOA->ODR &= ~(GPIO_ODR_OD5);
		}
	}
	return 0;
}
