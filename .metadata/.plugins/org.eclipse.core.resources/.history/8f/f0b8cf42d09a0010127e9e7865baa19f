#include <stdint.h>
#include <stdbool.h>
#define STM32F411xE
#include "stm32f4xx.h"

/// from friend
volatile bool engineON = false;
volatile int driveMode = 1; // eco=0, normal=1, sport=2
//////////

volatile int currentSpeed = 0;
volatile int currentGear = 0;

volatile bool a = true; // can accelator status?, 1 = can, 0 = can't
volatile float acc = 1.2f;

bool isSpeedZero(int speed) { // is speed = 0
	if (speed == 0) {
		return true;
	} else {
		return false;
	}
}

bool isSpeedEQGearN(int speed) {
	// is speed 0 //check gear N
	if (speed == 0) {
		return true;
	} else {
		return false;
	}
}

int checkSpeedEQGearOne(int speed) {
	//less = 0, in range = 1, more = 2
	// is speed 0 - 30 //check gear 1
	if (speed >= 0 && speed <= 30) {
		return 1;
	} else if (speed > 30) {
		return 2;
	}
	return 0;
}

int checkSpeedEQGearTwo(int speed) {
	//less = 0, in range = 1, more = 2
	// is speed 20 - 50 //check gear 2
	if (speed < 20) {
		return 0;
	} else if (speed >= 20 && speed <= 50) {
		return 1;
	} else if (speed > 50) {
		return 2;
	}
	return 0;
}

int checkSpeedEQGearThree(int speed) {
	//less = 0, in range = 1, more = 2
	// is speed 40 - 70 //check gear 3
	if (speed < 40) {
		return 0;
	} else if (speed >= 40 && speed <= 70) {
		return 1;
	} else if (speed > 70) {
		return 2;
	}
	return 0;
}

bool checkSpeedEQGearFour(int speed) {
	//less = 0, in range = 1, more = 2
	// is speed 60 - 90 //check gear 4
	if (speed < 60) {
		return 0;
	} else if (speed >= 60 && speed <= 90) {
		return 1;
	} else if (speed > 90) {
		return 2;
	}
	return 0;
}

bool checkSpeedEQGearFive(int speed) {
	//less = 0, in range = 1, more = 2
	// is speed 80 - 130 //check gear 5
	if (speed < 80) {
		return 0;
	} else if (speed >= 80 && speed <= 130) {
		return 1;
	} else if (speed > 130) {
		return 2;
	}
	return 0;
}

void EXTI3_IRQHandler(void) { //brake press
	if ((EXTI->PR & EXTI_PR_PR3) != 0) {
		a = false; // can't gas
		// reduce speed
		EXTI->PR |= EXTI_PR_PR3;
	}
}

void EXTI15_10_IRQHandler(void) { //clutch press
	if ((EXTI->PR & EXTI_PR_PR10) != 0) {
		if ((GPIOB->IDR & GPIO_IDR_ID10) == 0) {
			//check gear shift
			// reduce speed
		} else {

		}
		EXTI->PR |= EXTI_PR_PR10;
	}
}

void EXTI9_5_IRQHandler(void) { //gas press
	if ((EXTI->PR & EXTI_PR_PR5) != 0) {
		if ((GPIOB->IDR & GPIO_IDR_ID10) == 0) {

		} else {

		}
		EXTI->PR |= EXTI_PR_PR5;
	}
}

void ADC_IRQHandler(void) { // gear change

}

int gearChange(int potenPos) { //all = 4096
	int gap = 682;

	if (potenPos <= gap) {
		// 0 - 682
		// gear n

		// 0000
		GPIOC->ODR &= ~(GPIO_ODR_OD7);
		GPIOA->ODR &= ~(GPIO_ODR_OD8);
		GPIOB->ODR &= ~(GPIO_ODR_OD10);
		GPIOA->ODR &= ~(GPIO_ODR_OD9);

		return 0; // gear = 0
	} else if (potenPos > gap && potenPos <= gap * 2) {
		// 682 - 1364
		//gear 1

		// 0001
		GPIOC->ODR |= (GPIO_ODR_OD7);
		GPIOA->ODR &= ~(GPIO_ODR_OD8);
		GPIOB->ODR &= ~(GPIO_ODR_OD10);
		GPIOA->ODR &= ~(GPIO_ODR_OD9);

		return 1; // gear = 1
	} else if (potenPos > gap * 2 && potenPos <= gap * 3) {
		// 1364 - 2046
		//gear 2

		// 0010
		GPIOC->ODR &= ~(GPIO_ODR_OD7);
		GPIOA->ODR |= (GPIO_ODR_OD8);
		GPIOB->ODR &= ~(GPIO_ODR_OD10);
		GPIOA->ODR &= ~(GPIO_ODR_OD9);

		return 2; // gear = 2
	} else if (potenPos > gap * 3 && potenPos <= gap * 4) {
		// 2046 - 2728
		//gear 3

		// 0011
		GPIOC->ODR |= (GPIO_ODR_OD7);
		GPIOA->ODR |= (GPIO_ODR_OD8);
		GPIOB->ODR &= ~(GPIO_ODR_OD10);
		GPIOA->ODR &= ~(GPIO_ODR_OD9);

		return 3; // gear = 3
	} else if (potenPos > gap * 4 && potenPos <= gap * 5) {
		// 2728 - 3410
		//gear 4

		// 0100
		GPIOC->ODR &= ~(GPIO_ODR_OD7);
		GPIOA->ODR &= ~(GPIO_ODR_OD8);
		GPIOB->ODR |= (GPIO_ODR_OD10);
		GPIOA->ODR &= ~(GPIO_ODR_OD9);

		return 4; // gear = 4
	} else if (potenPos > gap * 5) {
		// 3410 - 4096
		//gear 5

		// 0101
		GPIOC->ODR |= (GPIO_ODR_OD7);
		GPIOA->ODR &= ~(GPIO_ODR_OD8);
		GPIOB->ODR |= (GPIO_ODR_OD10);
		GPIOA->ODR &= ~(GPIO_ODR_OD9);

		return 5; // gear = 5
	}
}

void checkDriveMode(int mode) {
	if (mode == 0) { // eco
		acc = 1;
	} else if (mode == 1) {
		acc = 1.2;
	} else if (mode == 2) {
		acc = 1.5;
	}
}

void SysTick_handler(void) {
	static int tickCouter = 0;

	if (!engineON) {
		currentSpeed = 0;
		return;
	}

	bool brakePress = ((GPIOB->IDR & GPIO_IDR_ID3) == 0);
	bool clutchPress = ((GPIOA->IDR & GPIO_IDR_ID10) == 0);
	bool gasPress = ((GPIOB->IDR & GPIO_IDR_ID5) == 0);

	ADC1->CR2 |= ADC_CR2_SWSTART;
	while (!(ADC1->SR & ADC_SR_EOC))
		; // wait for adc value
	int gear = gearChange(ADC1->DR);

	// gear change
	if (gear != currentGear) { // have gear changed
		if (clutchPress) {
			currentGear = gear;
		} else {
			engineON = false;
		}
	}

	// speed
	if (++tickCouter >= 10) {
		tickCouter = 0;

		// check brake
		if (brakePress){
			a = false;
			currentSpeed -= 5;
		}
		else if (gasPress && a == true && currentGear != 0){
			checkDriveMode(driveMode);
		}
	}
}

int main(void) {
	// enable clock
	RCC->AHB1ENR |= (RCC_AHB1ENR_GPIOAEN + RCC_AHB1ENR_GPIOBEN
			+ RCC_AHB1ENR_GPIOCEN + RCC_AHB1ENR_GPIODEN);
	RCC->APB2ENR |= RCC_APB2ENR_SYSCFGEN;

	// - 7 segment - // show gear

	GPIOC->MODER |= (0b01 << GPIO_MODER_MODER7_Pos);
	GPIOA->MODER |= (0b01 << GPIO_MODER_MODER8_Pos);
	GPIOB->MODER |= (0b01 << GPIO_MODER_MODER10_Pos);
	GPIOA->MODER |= (0b01 << GPIO_MODER_MODER9_Pos);

	// - PB3 - // brake
	GPIOB->MODER &= ~(GPIO_MODER_MODER3);
	GPIOB->PUPDR &= ~(GPIO_PUPDR_PUPD3);
	GPIOB->PUPDR |= (0b01 << GPIO_PUPDR_PUPD3_Pos);

	//EXTI
	EXTI->IMR |= EXTI_IMR_IM3;
	EXTI->RTSR |= EXTI_RTSR_TR3;
	EXTI->FTSR |= EXTI_FTSR_TR3;

	//EXTI port mux
	SYSCFG->EXTICR[0] &= ~SYSCFG_EXTICR1_EXTI3;
	SYSCFG->EXTICR[0] |= (1 << SYSCFG_EXTICR1_EXTI3_Pos);

	// - PB10 - // clutch
	GPIOA->MODER &= ~(GPIO_MODER_MODER10);
	GPIOA->PUPDR &= ~(GPIO_PUPDR_PUPD10);
	GPIOA->PUPDR |= (0b01 << GPIO_PUPDR_PUPD10_Pos);

	//EXTI
	EXTI->IMR |= EXTI_IMR_IM10;
	EXTI->RTSR |= EXTI_RTSR_TR10;
	EXTI->FTSR |= EXTI_FTSR_TR10;

	//EXTI port mux
	SYSCFG->EXTICR[2] &= ~SYSCFG_EXTICR3_EXTI3;
	SYSCFG->EXTICR[2] |= (1 << SYSCFG_EXTICR3_EXTI3_Pos);

	// - PB5 - // gas
	GPIOB->MODER &= ~(GPIO_MODER_MODER5);
	GPIOB->PUPDR &= ~(GPIO_PUPDR_PUPD5);
	GPIOB->PUPDR |= (0b01 << GPIO_PUPDR_PUPD5_Pos);

	//EXTI
	EXTI->IMR |= EXTI_IMR_IM5;
	EXTI->RTSR |= EXTI_RTSR_TR5;
	EXTI->FTSR |= EXTI_FTSR_TR5;

	//EXTI port mux
	SYSCFG->EXTICR[1] &= ~SYSCFG_EXTICR2_EXTI5;
	SYSCFG->EXTICR[1] |= (1 << SYSCFG_EXTICR2_EXTI5_Pos);

	// - Potentiameter - //
	GPIOA->MODER &= ~(GPIO_MODER_MODER4);
	GPIOA->MODER |= (0b11 << GPIO_MODER_MODER4_Pos);
	ADC1->CR2 |= ADC_CR2_ADON;
	ADC1->SMPR2 |= ADC_SMPR2_SMP4;
	ADC1->SQR1 &= ~(ADC_SQR1_L);
	ADC1->SQR1 |= (1 << ADC_SQR1_L_Pos);
	ADC1->SQR3 &= ~(ADC_SQR3_SQ1);
	ADC1->SQR3 |= (0x04 << ADC_SQR3_SQ1_Pos);
	ADC1->CR1 |= ADC_CR1_EOCIE;

	// enable
	NVIC_EnableIRQ(EXTI3_IRQn);
	NVIC_EnableIRQ(EXTI15_10_IRQn);
	NVIC_EnableIRQ(ADC_IRQn);
	NVIC_EnableIRQ(EXTI9_5_IRQn);

	//set priority
	NVIC_SetPriority(EXTI3_IRQn, 0);
	NVIC_SetPriority(EXTI15_10_IRQn, 1);
	NVIC_SetPriority(ADC_IRQn, 1);
	NVIC_SetPriority(EXTI9_5_IRQn, 2);

	while (1) {

	}
}
