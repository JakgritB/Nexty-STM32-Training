#include <stdint.h>
#define STM32F411xE
#include "stm32f4xx.h"

char vdg_UART_RxByte() {
	while ((USART2->SR & USART_SR_RXNE) == 0)
		;
	return USART2->DR;
}

int main(void) {
	RCC->AHB1ENR |= RCC_AHB1ENR_GPIOAEN;
	RCC->AHB1ENR |= RCC_AHB1ENR_GPIODEN;
	RCC->AHB1ENR |= RCC_AHB1ENR_GPIOCEN;
	RCC->AHB1ENR |= RCC_AHB1ENR_GPIOBEN;

	RCC->APB1ENR |= RCC_APB1ENR_USART2EN;

	// PA3 (RX only)
	GPIOA->MODER |= (0b10 << GPIO_MODER_MODER3_Pos);
	GPIOA->AFR[0] |= (0b0111 << GPIO_AFRL_AFSEL3_Pos);

	// PA5 (LED)
	GPIOA->MODER |= (0b01 << GPIO_MODER_MODER5_Pos);
	GPIOC->MODER |= (0b01 << GPIO_MODER_MODER7_Pos);
	GPIOA->MODER |= (0b01 << GPIO_MODER_MODER8_Pos);
	GPIOB->MODER |= (0b01 << GPIO_MODER_MODER10_Pos);
	GPIOB->MODER |= (0b01 << GPIO_MODER_MODER9_Pos);

	// USART (RX only)
	USART2->CR1 |= USART_CR1_UE;
	USART2->BRR = 139;
	USART2->CR1 |= USART_CR1_RE;

	while (1) {
		char received = vdg_UART_RxByte();

		if (received == '1') { //0001
			GPIOA->ODR |= (GPIO_ODR_OD5);
			GPIOC->ODR |= (GPIO_ODR_OD7);
			GPIOA->ODR &= ~(GPIO_ODR_OD8);
			GPIOB->ODR &= ~(GPIO_ODR_OD10);
			GPIOB->ODR &= ~(GPIO_ODR_OD9);
		}
		else if (received == '2') { //0010
			GPIOA->ODR |= (GPIO_ODR_OD5);
			GPIOC->ODR &= ~(GPIO_ODR_OD7);
			GPIOA->ODR |= (GPIO_ODR_OD8);
			GPIOB->ODR &= ~(GPIO_ODR_OD10);
			GPIOB->ODR &= ~(GPIO_ODR_OD9);
		}
		else if (received == '3') { //0011
			GPIOA->ODR |= (GPIO_ODR_OD5);
			GPIOC->ODR |= (GPIO_ODR_OD7);
			GPIOA->ODR |= (GPIO_ODR_OD8);
			GPIOB->ODR &= ~(GPIO_ODR_OD10);
			GPIOB->ODR &= ~(GPIO_ODR_OD9);
		}
		else if (received == '4') { //0100
			GPIOA->ODR |= (GPIO_ODR_OD5);
			GPIOC->ODR &= ~(GPIO_ODR_OD7);
			GPIOA->ODR &= ~(GPIO_ODR_OD8);
			GPIOB->ODR |= (GPIO_ODR_OD10);
			GPIOB->ODR &= ~(GPIO_ODR_OD9);
		}
		else if (received == '5') { //0101
			GPIOA->ODR |= (GPIO_ODR_OD5);
			GPIOC->ODR |= (GPIO_ODR_OD7);
			GPIOA->ODR &= ~(GPIO_ODR_OD8);
			GPIOB->ODR |= (GPIO_ODR_OD10);
			GPIOB->ODR &= ~(GPIO_ODR_OD9);
		}
		else if (received == '6') { //0110
			GPIOA->ODR |= (GPIO_ODR_OD5);
			GPIOC->ODR &= ~(GPIO_ODR_OD7);
			GPIOA->ODR |= (GPIO_ODR_OD8);
			GPIOB->ODR |= (GPIO_ODR_OD10);
			GPIOB->ODR &= ~(GPIO_ODR_OD9);
		}
		else if (received == '7') { //0111
			GPIOA->ODR |= (GPIO_ODR_OD5);
			GPIOC->ODR |= (GPIO_ODR_OD7);
			GPIOA->ODR |= (GPIO_ODR_OD8);
			GPIOB->ODR |= (GPIO_ODR_OD10);
			GPIOB->ODR &= ~(GPIO_ODR_OD9);
		}
		else if (received == '8') { //1000
			GPIOA->ODR |= (GPIO_ODR_OD5);
			GPIOC->ODR &= ~(GPIO_ODR_OD7);
			GPIOA->ODR &= ~(GPIO_ODR_OD8);
			GPIOB->ODR &= ~(GPIO_ODR_OD10);
			GPIOB->ODR |= (GPIO_ODR_OD9);
		}
		else if (received == '9') { //1001
			GPIOA->ODR |= (GPIO_ODR_OD5);
			GPIOC->ODR |= (GPIO_ODR_OD7);
			GPIOA->ODR &= ~(GPIO_ODR_OD8);
			GPIOB->ODR &= ~(GPIO_ODR_OD10);
			GPIOB->ODR |= (GPIO_ODR_OD9);
		}
		else {
			GPIOA->ODR &= ~(GPIO_ODR_OD5);
			GPIOC->ODR &= ~(GPIO_ODR_OD7);
			GPIOA->ODR &= ~(GPIO_ODR_OD8);
			GPIOB->ODR &= ~(GPIO_ODR_OD10);
			GPIOB->ODR &= ~(GPIO_ODR_OD9);

		}
	}
	return 0;
}
