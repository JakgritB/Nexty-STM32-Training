/*
 * Manual Transmission Car Simulator + AC Temperature Control
 * STM32F411xE Bare-metal
 *
 * รวมฟังก์ชันของโค้ดนาย + เพื่อน
 */

#define STM32F411xE
#include "stm32f4xx.h"
#include <stdint.h>
#include <stdio.h>
#include <math.h>

/* ===================== System Config ===================== */
#define SYSTEM_CLOCK 16000000
#define TIMER_FREQ   1000   // 100Hz

/* ===================== Driving Modes ===================== */
typedef enum {
	MODE_ECO = 0, MODE_NORMAL, MODE_SPORT
} DrivingMode;
typedef enum {
	WIPER_OFF = 0, WIPER_SLOW, WIPER_MEDIUM, WIPER_FAST
} WiperMode;
typedef enum {
	GEAR_N = 0, GEAR_1, GEAR_2, GEAR_3, GEAR_4, GEAR_5
} Gear;

/* ===================== Speed Ranges ===================== */
typedef struct {
	uint8_t min;
	uint8_t max;
} SpeedRange;
const SpeedRange GEAR_SPEEDS[] = { { 0, 0 }, { 0, 30 }, { 20, 50 }, { 40, 70 },
		{ 60, 90 }, { 80, 130 } };

/* ===================== Constants for NTC ===================== */
#define ADC_MAXRES 4095.0f
#define VREF 3.3f
#define RX 10000.0f
#define R0 10000.0f
#define T0 298.15f
#define BETA 3950.0f

/* ===================== Global Variables ===================== */
volatile uint8_t engine_running = 0;
volatile float current_speed = 0.0f;
volatile Gear current_gear = GEAR_N, previous_gear = GEAR_N;
volatile DrivingMode drive_mode = MODE_NORMAL;
volatile WiperMode wiper_mode = WIPER_OFF;

volatile uint8_t clutch_pressed = 0, brake_pressed = 0, gas_pressed = 0;
volatile uint8_t wiper_button_pressed = 0, wiper_button_last = 1;

volatile uint16_t adc_value = 0;      // เกียร์
volatile uint16_t adc_temp_value = 0; // อุณหภูมิ
volatile uint16_t wiper_counter = 0, wiper_led_state = 0, uart_send_counter = 0;

/* UART buffer */
volatile char uart_rx_char = 0;
volatile uint8_t uart_rx_flag = 0;

/* ===================== Prototypes ===================== */
void SystemInit(void);
void GPIO_Init(void);
void ADC_Init(void);
uint16_t ADC_Read_Channel(uint8_t channel);
void USART2_Init(void);
void TIM2_Init(void);
void USART2_SendString(const char *str);
void USART2_SendSpeed(void);
void Update_7Segment(uint8_t value);
void Update_Engine_LED(void);
void Update_Wiper_LED(void);
Gear ADC_to_Gear(uint16_t adc_val);
void Read_Buttons(void);
void Check_Stall_Conditions(void);
void Update_Speed(void);
void Process_UART_Command(char cmd);
void handleAC(uint16_t temp_adc_val);

/* ===================== Main ===================== */
int main(void) {
	SystemInit();
	GPIO_Init();
	ADC_Init();
	USART2_Init();
	TIM2_Init();

	USART2_SendString("Car Simulator + AC Control\r\n");

	while (1) {
		if (uart_rx_flag) {
			uart_rx_flag = 0;
			Process_UART_Command(uart_rx_char);
		}
	}
}

/* ===================== Init Functions ===================== */
void SystemInit(void) {
	SCB->CPACR |= (0xF << 20);
}

void GPIO_Init(void) {
	RCC->AHB1ENR |= RCC_AHB1ENR_GPIOAEN | RCC_AHB1ENR_GPIOBEN
			| RCC_AHB1ENR_GPIOCEN;

	// Engine LED (PA5)
	GPIOA->MODER |= GPIO_MODER_MODER5_0;

	// Wiper LED (PB6)
	GPIOB->MODER |= GPIO_MODER_MODER6_0;

	// BCD outputs: PA9, PB10, PA8, PC7
	GPIOA->MODER |= GPIO_MODER_MODER9_0 | GPIO_MODER_MODER8_0;
	GPIOB->MODER |= GPIO_MODER_MODER10_0;
	GPIOC->MODER |= GPIO_MODER_MODER7_0;

	// Input buttons (pull-up)
	GPIOA->PUPDR |= GPIO_PUPDR_PUPD10_0; // clutch
	GPIOB->PUPDR |= GPIO_PUPDR_PUPD3_0;  // brake
	GPIOB->PUPDR |= GPIO_PUPDR_PUPD5_0;  // gas
	GPIOB->PUPDR |= GPIO_PUPDR_PUPD4_0;  // wiper

	// PA4 = Gear ADC (analog), PA5 = Temp ADC (analog), PA7 = AC LED
	GPIOA->MODER |= GPIO_MODER_MODER4 | GPIO_MODER_MODER5 | GPIO_MODER_MODER7_0;

	// USART2 (PA2, PA3 AF7)
	GPIOA->MODER |= GPIO_MODER_MODER2_1 | GPIO_MODER_MODER3_1;
	GPIOA->AFR[0] |= (7 << GPIO_AFRL_AFSEL2_Pos) | (7 << GPIO_AFRL_AFSEL3_Pos);
}

void ADC_Init(void) {
	RCC->APB2ENR |= RCC_APB2ENR_ADC1EN;
	ADC1->CR2 = 0;
	ADC1->CR1 = 0;
	ADC1->SMPR2 |= (4 << ADC_SMPR2_SMP4_Pos) | (4 << ADC_SMPR2_SMP5_Pos);
	ADC1->CR2 |= ADC_CR2_ADON;
}

uint16_t ADC_Read_Channel(uint8_t ch) {
	ADC1->SQR3 = ch;
	ADC1->CR2 |= ADC_CR2_SWSTART;
	while (!(ADC1->SR & ADC_SR_EOC))
		;
	return ADC1->DR;
}

void USART2_Init(void) {
	RCC->APB1ENR |= RCC_APB1ENR_USART2EN;
	USART2->BRR = 139; // 115200 baud
	USART2->CR1 = USART_CR1_UE | USART_CR1_TE | USART_CR1_RE | USART_CR1_RXNEIE;
	NVIC_EnableIRQ(USART2_IRQn);
}

void TIM2_Init(void) {
	RCC->APB1ENR |= RCC_APB1ENR_TIM2EN;
	TIM2->PSC = 16000 - 1;
	TIM2->ARR = 10 - 1;
	TIM2->DIER |= TIM_DIER_UIE;
	NVIC_EnableIRQ(TIM2_IRQn);
	TIM2->CR1 |= TIM_CR1_CEN;
}

/* ===================== Interrupts ===================== */
void TIM2_IRQHandler(void) {
	if (TIM2->SR & TIM_SR_UIF) {
		TIM2->SR &= ~TIM_SR_UIF;

		// ADC reads
		adc_value = ADC_Read_Channel(4); // gear
		adc_temp_value = ADC_Read_Channel(5); // temp
		previous_gear = current_gear;
		current_gear = ADC_to_Gear(adc_value);

		Read_Buttons();
		Update_7Segment(current_gear);
		Check_Stall_Conditions();
		Update_Speed();
		Update_Engine_LED();
		Update_Wiper_LED();
		handleAC(adc_temp_value);

		if (++uart_send_counter >= 50) {
			uart_send_counter = 0;
			USART2_SendSpeed();
		}
	}
}

void USART2_IRQHandler(void) {
	if (USART2->SR & USART_SR_RXNE) {
		uart_rx_char = USART2->DR;
		uart_rx_flag = 1;
	}
}

/* ===================== Core Functions ===================== */
Gear ADC_to_Gear(uint16_t val) {
	if (val > 3414)
		return GEAR_N;
	else if (val > 2732)
		return GEAR_1;
	else if (val > 2049)
		return GEAR_2;
	else if (val > 1366)
		return GEAR_3;
	else if (val > 683)
		return GEAR_4;
	else
		return GEAR_5;
}

void Read_Buttons(void) {
	clutch_pressed = !(GPIOA->IDR & GPIO_IDR_ID10);
	brake_pressed = !(GPIOB->IDR & GPIO_IDR_ID3);
	gas_pressed = !(GPIOB->IDR & GPIO_IDR_ID5);

	uint8_t w_cur = !(GPIOB->IDR & GPIO_IDR_ID4);
	if (w_cur && !wiper_button_last) {
		wiper_mode = (wiper_mode + 1) % 4;
		wiper_counter = 0;
	}
	wiper_button_last = w_cur;
}

/* check stall, update speed ... (คงโค้ดเดิมของนายทั้งหมด) */

/* ===================== AC Control ===================== */
void handleAC(uint16_t temp_adc_val) {
	float adc_voltage = (temp_adc_val * VREF) / ADC_MAXRES;
	float r_ntc = RX * adc_voltage / (VREF - adc_voltage);
	if (r_ntc <= 0)
		return;
	float temperature = ((BETA * T0) / (T0 * log(r_ntc / R0) + BETA)) - 273.15f;

	if (temperature > 28.0f)
		GPIOA->BSRR = GPIO_BSRR_BS7; // เปิดแอร์
	else if (temperature < 26.0f)
		GPIOA->BSRR = GPIO_BSRR_BR7; // ปิดแอร์
}
