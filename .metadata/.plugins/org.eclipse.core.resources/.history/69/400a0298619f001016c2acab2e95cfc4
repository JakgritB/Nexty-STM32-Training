#include <stdint.h>
#define STM32F411xE
#include "stm32f4xx.h"
#include <math.h>

// ============================================
// ค่าคงที่และการตั้งค่า
// ============================================
#define SYSTEM_CLOCK 16000000
#define TIMER_100HZ  1000

// ค่าคงที่สำหรับ Temperature Sensor (NTC)
#define ADC_MAX      4095.0f
#define VREF         3.3f
#define R_FIXED      10000.0f
#define R0           10000.0f
#define T0           298.15f
#define BETA         3950.0f

// ค่าความเร่ง/ชะลอ (km/h ต่อวินาที)
#define ACCEL_ECO       25.0f
#define ACCEL_NORMAL    75.0f
#define ACCEL_SPORT     100.0f
#define DECEL_BRAKE     100.0f
#define DECEL_COAST     5.0f

// ============================================
// Enumerations (ไม่ใช้ typedef เพื่อความเรียบง่าย)
// ============================================

// โหมดการขับขี่
enum {
	MODE_ECO = 0, MODE_NORMAL, MODE_SPORT
};

// โหมดที่ปัดน้ำฝน
enum {
	WIPER_OFF = 0, WIPER_SLOW, WIPER_MEDIUM, WIPER_FAST
};

// เกียร์
enum {
	GEAR_N = 0, GEAR_1, GEAR_2, GEAR_3, GEAR_4, GEAR_5
};

// ============================================
// ตัวแปร Global
// ============================================

// สถานะรถ
volatile uint8_t engine_running = 0;        // เครื่องยนต์เปิดอยู่หรือไม่
volatile float current_speed = 0.0f;        // ความเร็วปัจจุบัน (km/h)
volatile uint8_t current_gear = GEAR_N;     // เกียร์ปัจจุบัน
volatile uint8_t previous_gear = GEAR_N;    // เกียร์ก่อนหน้า
volatile uint8_t drive_mode = MODE_NORMAL;  // โหมดการขับขี่
volatile uint8_t wiper_mode = WIPER_OFF;    // โหมดที่ปัดน้ำฝน

// สถานะปุ่ม
volatile uint8_t clutch_pressed = 0;
volatile uint8_t brake_pressed = 0;
volatile uint8_t gas_pressed = 0;
volatile uint8_t wiper_button_last = 1;     // สำหรับ debounce

// ค่า ADC
volatile uint16_t adc_gear = 0;
volatile uint16_t adc_temp = 0;
volatile uint16_t adc_light = 0;

// ตัวนับ
volatile uint16_t wiper_counter = 0;
volatile uint16_t wiper_led_state = 0;
volatile uint16_t uart_counter = 0;

// UART
volatile char uart_rx_char = 0;
volatile uint8_t uart_rx_flag = 0;

// ช่วงความเร็วของแต่ละเกียร์ (min, max)
const uint8_t gear_speed_min[] = { 0, 0, 20, 40, 60, 80 };
const uint8_t gear_speed_max[] = { 0, 30, 50, 70, 90, 130 };

// ============================================
// ฟังก์ชันสำหรับอ่านค่า ADC
// ============================================
uint16_t read_adc(uint8_t channel) {
	ADC1->SQR3 = channel;
	ADC1->CR2 |= ADC_CR2_SWSTART;
	while (!(ADC1->SR & ADC_SR_EOC))
		;
	return ADC1->DR;
}

// ============================================
// แปลงค่า ADC เป็นเกียร์
// ============================================
uint8_t adc_to_gear(uint16_t adc_value) {
	if (adc_value > 3414)
		return GEAR_N;
	else if (adc_value > 2732)
		return GEAR_1;
	else if (adc_value > 2049)
		return GEAR_2;
	else if (adc_value > 1366)
		return GEAR_3;
	else if (adc_value > 683)
		return GEAR_4;
	else
		return GEAR_5;
}

// ============================================
// อ่านสถานะปุ่มทั้งหมด
// ============================================
void read_all_buttons(void) {
	// อ่านปุ่ม (Active Low)
	clutch_pressed = !(GPIOA->IDR & GPIO_IDR_ID10);
	brake_pressed = !(GPIOB->IDR & GPIO_IDR_ID3);
	gas_pressed = !(GPIOB->IDR & GPIO_IDR_ID5);

	// ปุ่ม Wiper (ตรวจจับขอบขาขึ้น)
	uint8_t wiper_now = !(GPIOB->IDR & GPIO_IDR_ID4);
	if (wiper_now && !wiper_button_last) {
		wiper_mode = (wiper_mode + 1) % 4;
		wiper_counter = 0;
	}
	wiper_button_last = wiper_now;
}

// ============================================
// ตรวจสอบเงื่อนไขที่ทำให้เครื่องดับ
// ============================================
void check_engine_stall(void) {
	if (!engine_running)
		return;

	// 1. เปลี่ยนเกียร์โดยไม่เหยียบคลัตช์
	if (current_gear != previous_gear && !clutch_pressed) {
		engine_running = 0;
		return;
	}

	// 2. เกียร์ 1 ความเร็ว 0 ไม่เหยียบคลัตช์/แก๊ส
	if (current_gear == GEAR_1 && current_speed < 0.1f && !gas_pressed
			&& !clutch_pressed) {
		engine_running = 0;
		return;
	}

	// 3. ความเร็วไม่เหมาะกับเกียร์ (เมื่อไม่เหยียบคลัตช์)
	if (current_gear != GEAR_N && !clutch_pressed) {
		// ความเร็วสูงเกินไป
		if (current_speed > gear_speed_max[current_gear]) {
			engine_running = 0;
			return;
		}
		// ความเร็วต่ำเกินไป (ยกเว้นเกียร์ 1)
		if (current_gear != GEAR_1
				&& current_speed < gear_speed_min[current_gear]) {
			engine_running = 0;
			return;
		}
	}
}

// ============================================
// คำนวณความเร็วรถ
// ============================================
void calculate_speed(void) {
	if (!engine_running) {
		current_speed = 0.0f;
		return;
	}

	// เลือกค่าความเร่งตามโหมด
	float accel = ACCEL_NORMAL;
	if (drive_mode == MODE_ECO)
		accel = ACCEL_ECO;
	else if (drive_mode == MODE_SPORT)
		accel = ACCEL_SPORT;

	// เบรกมีความสำคัญสูงสุด
	if (brake_pressed) {
		current_speed -= DECEL_BRAKE / TIMER_100HZ;
		if (current_speed < 0.0f)
			current_speed = 0.0f;
		return;
	}

	// เหยียบคลัตช์ = ไม่สามารถเร่งได้ (ยกเว้นเกียร์ 1 กรณีพิเศษ)
	if (clutch_pressed) {
		if (current_gear == GEAR_1 && current_speed < 10.0f && gas_pressed) {
			current_speed += accel / TIMER_100HZ;
			if (current_speed > 10.0f)
				current_speed = 10.0f;
		} else {
			current_speed -= DECEL_COAST / TIMER_100HZ;
			if (current_speed < 0.0f)
				current_speed = 0.0f;
		}
		return;
	}

	// เกียร์ว่าง = รถไม่วิ่ง
	if (current_gear == GEAR_N) {
		current_speed -= DECEL_COAST / TIMER_100HZ;
		if (current_speed < 0.0f)
			current_speed = 0.0f;
		return;
	}

	// เหยียบแก๊ส = เร่ง
	if (gas_pressed) {
		current_speed += accel / TIMER_100HZ;
		// จำกัดความเร็วไม่ให้เกินเกียร์
		if (current_speed > gear_speed_max[current_gear]) {
			current_speed = gear_speed_max[current_gear];
		}
	} else {
		// ปล่อยแก๊ส = ชะลอเบาๆ
		current_speed -= DECEL_COAST / TIMER_100HZ;
		if (current_speed < 0.0f)
			current_speed = 0.0f;
	}
}

// ============================================
// อัพเดต 7-Segment Display (BCD)
// ============================================
void update_7segment(uint8_t value) {
	// ปิดทุกบิตก่อน
	GPIOA->BSRR = GPIO_BSRR_BR9 | GPIO_BSRR_BR8;
	GPIOB->BSRR = GPIO_BSRR_BR10;
	GPIOC->BSRR = GPIO_BSRR_BR7;

	// เปิดบิตที่ต้องการ
	if (value & 0x08)
		GPIOA->BSRR = GPIO_BSRR_BS9;   // MSB
	if (value & 0x04)
		GPIOB->BSRR = GPIO_BSRR_BS10;
	if (value & 0x02)
		GPIOA->BSRR = GPIO_BSRR_BS8;
	if (value & 0x01)
		GPIOC->BSRR = GPIO_BSRR_BS7;   // LSB
}

// ============================================
// อัพเดต LED เครื่องยนต์ (PA5)
// ============================================
void update_engine_led(void) {
	if (engine_running) {
		GPIOA->BSRR = GPIO_BSRR_BS5;
	} else {
		GPIOA->BSRR = GPIO_BSRR_BR5;
	}
}

// ============================================
// อัพเดต LED ที่ปัดน้ำฝน (PB6)
// ============================================
void update_wiper_led(void) {
	if (wiper_mode == WIPER_OFF) {
		GPIOB->BSRR = GPIO_BSRR_BR6;
		return;
	}

	// กำหนดคาบเวลาการกระพริบ
	uint16_t period = 100; // SLOW = 1 วินาที
	if (wiper_mode == WIPER_MEDIUM)
		period = 50;
	else if (wiper_mode == WIPER_FAST)
		period = 10;

	wiper_counter++;
	if (wiper_counter >= period) {
		wiper_counter = 0;
		wiper_led_state = !wiper_led_state;
	}

	if (wiper_led_state) {
		GPIOB->BSRR = GPIO_BSRR_BS6;
	} else {
		GPIOB->BSRR = GPIO_BSRR_BR6;
	}
}

// ============================================
// อัพเดต LED ไฟหน้า (PA6)
// ============================================
void update_headlight_led(void) {
	// แสงน้อย (ADC > 2048) = เปิดไฟ
	if (adc_light > 2048) {
		GPIOA->BSRR = GPIO_BSRR_BS6;
	} else {
		GPIOA->BSRR = GPIO_BSRR_BR6;
	}
}

// ============================================
// อัพเดต LED แอร์ (PA7)
// ============================================
void update_ac_led(void) {
	// คำนวณอุณหภูมิจาก NTC Sensor
	float voltage = (adc_temp * VREF) / ADC_MAX;
	float r_ntc = R_FIXED * voltage / (VREF - voltage);

	if (r_ntc <= 0)
		return;

	float temp = ((BETA * T0) / (T0 * log(r_ntc / R0) + BETA)) - 273.15f;

	// Hysteresis: เปิดที่ >28°C, ปิดที่ <26°C
	if (temp > 30.0f) {
		GPIOA->BSRR = GPIO_BSRR_BS7;
	} else if (temp < 27.0f) {
		GPIOA->BSRR = GPIO_BSRR_BR7;
	}
}

// ============================================
// ส่งข้อความทาง UART
// ============================================
void uart_send_string(const char *str) {
	while (*str) {
		while (!(USART2->SR & USART_SR_TXE))
			;
		USART2->DR = *str++;
	}
}

// ============================================
// ส่งความเร็วทาง UART
// ============================================
void uart_send_speed(void) {
	char buffer[32];
	int speed = (int) current_speed;

	// สร้างข้อความ
	buffer[0] = 'S';
	buffer[1] = 'p';
	buffer[2] = 'e';
	buffer[3] = 'e';
	buffer[4] = 'd';
	buffer[5] = ':';
	buffer[6] = ' ';

	int idx = 7;
	if (speed == 0) {
		buffer[idx++] = '0';
	} else {
		// แปลงตัวเลขเป็นข้อความ
		int temp = speed;
		int digits = 0;
		while (temp > 0) {
			temp /= 10;
			digits++;
		}
		for (int i = digits - 1; i >= 0; i--) {
			buffer[idx + i] = '0' + (speed % 10);
			speed /= 10;
		}
		idx += digits;
	}

	buffer[idx++] = ' ';
	buffer[idx++] = 'k';
	buffer[idx++] = 'm';
	buffer[idx++] = '/';
	buffer[idx++] = 'h';
	buffer[idx++] = '\r';
	buffer[idx++] = '\n';
	buffer[idx] = '\0';

	uart_send_string(buffer);
}

// ============================================
// ประมวลผลคำสั่งจาก UART
// ============================================
void process_uart_command(char cmd) {
	if (cmd == 'o' || cmd == 'O') {
		if (current_gear == GEAR_N && !engine_running) {
			engine_running = 1;
			uart_send_string("Engine started\r\n");
		}
	} else if (cmd == 'f' || cmd == 'F') {
		engine_running = 0;
		uart_send_string("Engine stopped\r\n");
	} else if (cmd == 'e' || cmd == 'E') {
		drive_mode = MODE_ECO;
		uart_send_string("Mode: ECO\r\n");
	} else if (cmd == 'n' || cmd == 'N') {
		drive_mode = MODE_NORMAL;
		uart_send_string("Mode: NORMAL\r\n");
	} else if (cmd == 's' || cmd == 'S') {
		drive_mode = MODE_SPORT;
		uart_send_string("Mode: SPORT\r\n");
	}
}

// ============================================
// Interrupt Handler: Timer 2 (100Hz)
// ============================================
void TIM2_IRQHandler(void) {
	if (TIM2->SR & TIM_SR_UIF) {
		TIM2->SR &= ~TIM_SR_UIF;

		// --- อ่านค่า ADC ทั้งหมด ---
		adc_gear = read_adc(4);   // PA4
		adc_temp = read_adc(0);   // PA0
		adc_light = read_adc(1);  // PA1

		// --- ประมวลผล ---
		previous_gear = current_gear;
		current_gear = adc_to_gear(adc_gear);
		read_all_buttons();
		check_engine_stall();
		calculate_speed();

		// --- อัพเดตการแสดงผล ---
		update_7segment(current_gear);
		update_engine_led();
		update_wiper_led();
		update_headlight_led();
		update_ac_led();

		// --- ส่งข้อมูลทาง UART ทุก 500ms ---
		uart_counter++;
		if (uart_counter >= 50) {
			uart_counter = 0;
			uart_send_speed();
		}
	}
}

// ============================================
// Interrupt Handler: USART2
// ============================================
void USART2_IRQHandler(void) {
	if (USART2->SR & USART_SR_RXNE) {
		uart_rx_char = USART2->DR;
		uart_rx_flag = 1;
	}
}

// ============================================
// MAIN FUNCTION
// ============================================
int main(void) {
	// --- 1. เปิด FPU (สำหรับ float) ---
	SCB->CPACR |= ((3UL << 10 * 2) | (3UL << 11 * 2));
	__DSB();
	__ISB();

	// --- 2. เปิด Clock สำหรับ GPIO, UART, ADC, Timer ---
	RCC->AHB1ENR |= RCC_AHB1ENR_GPIOAEN | RCC_AHB1ENR_GPIOBEN
			| RCC_AHB1ENR_GPIOCEN;
	RCC->APB1ENR |= RCC_APB1ENR_USART2EN | RCC_APB1ENR_TIM2EN;
	RCC->APB2ENR |= RCC_APB2ENR_ADC1EN;

	// --- 3. ตั้งค่า GPIO Outputs (LEDs) ---
	GPIOA->MODER |= (0b01 << GPIO_MODER_MODER5_Pos);  // PA5: Engine LED
	GPIOA->MODER |= (0b01 << GPIO_MODER_MODER6_Pos);  // PA6: Headlight LED
	GPIOA->MODER |= (0b01 << GPIO_MODER_MODER7_Pos);  // PA7: AC LED
	GPIOB->MODER |= (0b01 << GPIO_MODER_MODER6_Pos);  // PB6: Wiper LED

	// --- 4. ตั้งค่า GPIO Outputs (7-Segment BCD) ---
	GPIOA->MODER |= (0b01 << GPIO_MODER_MODER9_Pos);  // PA9: BCD MSB
	GPIOB->MODER |= (0b01 << GPIO_MODER_MODER10_Pos); // PB10
	GPIOA->MODER |= (0b01 << GPIO_MODER_MODER8_Pos);  // PA8
	GPIOC->MODER |= (0b01 << GPIO_MODER_MODER7_Pos);  // PC7: BCD LSB

	// --- 5. ตั้งค่า GPIO Inputs (Buttons with Pull-up) ---
	GPIOA->MODER &= ~GPIO_MODER_MODER10;              // PA10: Clutch
	GPIOA->PUPDR |= (0b01 << GPIO_PUPDR_PUPD10_Pos);

	GPIOB->MODER &= ~GPIO_MODER_MODER3;               // PB3: Brake
	GPIOB->PUPDR |= (0b01 << GPIO_PUPDR_PUPD3_Pos);

	GPIOB->MODER &= ~GPIO_MODER_MODER5;               // PB5: Gas
	GPIOB->PUPDR |= (0b01 << GPIO_PUPDR_PUPD5_Pos);

	GPIOB->MODER &= ~GPIO_MODER_MODER4;               // PB4: Wiper
	GPIOB->PUPDR |= (0b01 << GPIO_PUPDR_PUPD4_Pos);

	// --- 6. ตั้งค่า GPIO Analog Inputs ---
	GPIOA->MODER |= (0b11 << GPIO_MODER_MODER4_Pos);  // PA4: Gear Pot
	GPIOA->MODER |= (0b11 << GPIO_MODER_MODER0_Pos);  // PA0: Temp Sensor
	GPIOA->MODER |= (0b11 << GPIO_MODER_MODER1_Pos);  // PA1: Light Sensor

	// --- 7. ตั้งค่า UART (PA2=TX, PA3=RX) ---
	GPIOA->MODER |= (0b10 << GPIO_MODER_MODER2_Pos)
			| (0b10 << GPIO_MODER_MODER3_Pos);
	GPIOA->AFR[0] |= (0b0111 << GPIO_AFRL_AFSEL2_Pos)
			| (0b0111 << GPIO_AFRL_AFSEL3_Pos);

	USART2->BRR = 139;  // 115200 baud @ 16MHz
	USART2->CR1 = USART_CR1_UE | USART_CR1_TE | USART_CR1_RE | USART_CR1_RXNEIE;

	// --- 8. ตั้งค่า ADC ---
	ADC1->CR2 |= ADC_CR2_ADON;
	ADC1->SQR1 = 0;  // 1 conversion
	ADC1->SMPR2 |= (4 << ADC_SMPR2_SMP0_Pos) | (4 << ADC_SMPR2_SMP1_Pos)
			| (4 << ADC_SMPR2_SMP4_Pos);

	// --- 9. ตั้งค่า Timer 2 (100Hz) ---
	TIM2->PSC = 16000 - 1;  // 1ms tick
	TIM2->ARR = 10 - 1;     // 10ms period
	TIM2->DIER |= TIM_DIER_UIE;
	TIM2->CR1 |= TIM_CR1_CEN;

	// --- 10. เปิด Interrupts ---
	NVIC_EnableIRQ(USART2_IRQn);
	NVIC_EnableIRQ(TIM2_IRQn);
	__enable_irq();

	// --- ข้อความเริ่มต้น ---
	uart_send_string("=== Manual Car Simulator ===\r\n");
	uart_send_string("o=start, f=stop, e=eco, n=normal, s=sport\r\n");

	// --- Main Loop ---
	while (1) {
		// ตรวจสอบคำสั่งจาก UART
		if (uart_rx_flag) {
			uart_rx_flag = 0;
			process_uart_command(uart_rx_char);
		}
	}
}
